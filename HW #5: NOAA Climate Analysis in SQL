-- HW #5: NOAA Climate Analysis in SQL

-- 1. Normalize units (tenths → real values)
-- Create a view with scaled values
CREATE OR REPLACE VIEW weather_normalized AS
SELECT
    STATION,
    CAST(SUBSTR(DATE, 1, 4) AS INT) AS YEAR,
    CAST(SUBSTR(DATE, 5, 2) AS INT) AS MONTH,
    CAST(SUBSTR(DATE, 7, 2) AS INT) AS DAY,
    TMAX / 10.0 AS TMAX_C,
    TMIN / 10.0 AS TMIN_C,
    TAVG / 10.0 AS TAVG_C,
    PRCP / 10.0 AS PRCP_MM
FROM noaa_weather
WHERE DATE IS NOT NULL;

-- 2. Flag extreme days (heatwave ≥ 32°C, heavy rain ≥ 25 mm)
CREATE OR REPLACE VIEW weather_extremes AS
SELECT
    *,
    CASE WHEN TMAX_C >= 32.0 THEN 1 ELSE 0 END AS is_heatwave_day,
    CASE WHEN PRCP_MM >= 25.0 THEN 1 ELSE 0 END AS is_heavy_rain_day
FROM weather_normalized;

-- 3. Monthly summaries
CREATE OR REPLACE VIEW monthly_summary AS
SELECT
    STATION,
    YEAR,
    MONTH,
    AVG(TMAX_C) AS TMAX_mean,
    AVG(TMIN_C) AS TMIN_mean,
    AVG(TAVG_C) AS TAVG_mean,
    SUM(PRCP_MM) AS PRCP_total,
    AVG(PRCP_MM) AS PRCP_mean,
    SUM(is_heatwave_day) AS heatwave_days,
    SUM(is_heavy_rain_day) AS heavy_rain_days
FROM weather_extremes
GROUP BY STATION, YEAR, MONTH
ORDER BY STATION, YEAR, MONTH;

-- 4. Annual summaries
CREATE OR REPLACE VIEW annual_summary AS
SELECT
    STATION,
    YEAR,
    AVG(TMAX_C) AS TMAX_mean,
    AVG(TMIN_C) AS TMIN_mean,
    AVG(TAVG_C) AS TAVG_mean,
    SUM(PRCP_MM) AS PRCP_total,
    AVG(PRCP_MM) AS PRCP_mean,
    SUM(is_heatwave_day) AS heatwave_days,
    SUM(is_heavy_rain_day) AS heavy_rain_days
FROM weather_extremes
GROUP BY STATION, YEAR
ORDER BY STATION, YEAR;

-- 5. Diurnal Temperature Range (DTR)
CREATE OR REPLACE VIEW dtr_summary AS
SELECT
    STATION,
    YEAR,
    AVG(TMAX_C - TMIN_C) AS DTR_mean
FROM weather_normalized
GROUP BY STATION, YEAR
ORDER BY STATION, YEAR;

-- 6. Precipitation anomaly (relative to long-term mean)
WITH long_term AS (
    SELECT AVG(PRCP_total) AS mean_prcp
    FROM annual_summary
)
SELECT
    a.STATION,
    a.YEAR,
    a.PRCP_total,
    a.PRCP_total - l.mean_prcp AS anomaly_mm
FROM annual_summary a, long_term l
ORDER BY a.YEAR;
